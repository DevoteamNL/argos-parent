{
  "create": "accounts-keyinfo",
  "viewOn": "serviceAccounts",
  "pipeline": [
    {
      "$facet": {
        "serviceaccounts": [
          {
            "$lookup": {
              "from": "hierarchy",
              "localField": "accountId",
              "foreignField": "referenceId",
              "as": "joinedhierarchy"
            }
          },
          {
            "$project": {
              "accountId": 1.0,
              "name": 1.0,
              "inactiveKeys": "$inactiveKeyPairs.keyId",
              "activeKey": {
                "$cond": [
                  {
                    "$ne": [
                      {
                        "$ifNull": [
                          "$activeKeyPair.keyId",
                          ""
                        ]
                      },
                      ""
                    ]
                  },
                  [
                    {
                      "keyId": "$activeKeyPair.keyId",
                      "status": "ACTIVE"
                    }
                  ],
                  null
                ]
              },
              "accountType": {
                "$arrayElemAt": [
                  "$joinedhierarchy.type",
                  0.0
                ]
              },
              "pathToRoot": {
                "$arrayElemAt": [
                  "$joinedhierarchy.pathToRoot",
                  0.0
                ]
              },
              "_class": "com.rabobank.argos.domain.account.AccountKeyInfo"
            }
          }
        ],
        "personalaccounts": [
          {
            "$limit": 1.0
          },
          {
            "$project": {
              "_id": "$$REMOVE"
            }
          },
          {
            "$lookup": {
              "from": "personalaccounts",
              "pipeline": [
              ],
              "as": "joinedpersonalaccounts"
            }
          },
          {
            "$unwind": "$joinedpersonalaccounts"
          },
          {
            "$project": {
              "_id": "$joinedpersonalaccounts._id",
              "accountId": "$joinedpersonalaccounts.accountId",
              "name": "$joinedpersonalaccounts.name",
              "inactiveKeys": "$joinedpersonalaccounts.inactiveKeyPairs.keyId",
              "activeKey": {
                "$cond": [
                  {
                    "$ne": [
                      {
                        "$ifNull": [
                          "$joinedpersonalaccounts.activeKeyPair.keyId",
                          ""
                        ]
                      },
                      ""
                    ]
                  },
                  [
                    {
                      "keyId": "$joinedpersonalaccounts.activeKeyPair.keyId",
                      "status": "ACTIVE"
                    }
                  ],
                  null
                ]
              },
              "accountType": "PERSONAL_ACCOUNT",
              "pathToRoot": [
              ],
              "_class": "com.rabobank.argos.domain.account.AccountKeyInfo"
            }
          }
        ]
      }
    },
    {
      "$project": {
        "accounts": {
          "$concatArrays": [
            "$serviceaccounts",
            "$personalaccounts"
          ]
        }
      }
    },
    {
      "$unwind": "$accounts"
    },
    {
      "$replaceRoot": {
        "newRoot": "$accounts"
      }
    },
    {
      "$unwind": {
        "path": "$inactiveKeys",
        "preserveNullAndEmptyArrays": true
      }
    },
    {
      "$addFields": {
        "inactiveKeyInfo": {
          "$cond": [
            {
              "$ne": [
                {
                  "$ifNull": [
                    "$inactiveKeys",
                    ""
                  ]
                },
                ""
              ]
            },
            {
              "keyId": "$inactiveKeys",
              "status": "INACTIVE"
            },
            null
          ]
        }
      }
    },
    {
      "$group": {
        "_id": "$_id",
        "accountId": {
          "$first": "$accountId"
        },
        "name": {
          "$first": "$name"
        },
        "accountType": {
          "$first": "$accountType"
        },
        "pathToRoot": {
          "$first": "$pathToRoot"
        },
        "activeKey": {
          "$first": "$activeKey"
        },
        "inactiveKeyInfo": {
          "$push": "$inactiveKeyInfo"
        },
        "_class": {
          "$first": "$_class"
        }
      }
    },
    {
      "$project": {
        "_id": 1,
        "accountId": 1,
        "name": 1,
        "accountType": 1,
        "pathToRoot": 1,
        "_class": 1,
        "key": {
          "$filter": {
            "input": {
              "$concatArrays": [
                {
                  "$ifNull": [
                    "$activeKey",
                    []
                  ]
                },
                "$inactiveKeyInfo"
              ]
            },
            "as": "inputWithNulls",
            "cond": {
              "$ne": [
                "$$inputWithNulls",
                null
              ]
            }
          }
        }
      }
    },
    {
      "$unwind": {
        "path": "$key",
        "preserveNullAndEmptyArrays": false
      }
    }
  ]
}

